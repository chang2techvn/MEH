# Daily Challenges System

## Overview
The Daily Challenges system automatically fetches 10 fresh YouTube videos every day and presents them as English learning challenges on the `/challenges` route.

## Key Features

### üéØ Daily Video Refresh
- **10 videos per day**: System automatically generates exactly 10 new video challenges daily
- **Smart caching**: Videos are cached and only refreshed once per day
- **Fallback system**: If fetching fails, fallback to cached or database content

### üè∑Ô∏è Challenge Categories
- **Daily Challenges**: 10 auto-generated videos for today
- **User Challenges**: Challenges created by users
- **All Challenges**: Combined view of daily + user challenges
- **Difficulty Tabs**: Filter by beginner, intermediate, advanced

### üîÑ Automatic Cleanup
- **Expired challenges**: Auto-generated challenges expire after 30 days
- **Daily batch management**: Keep only latest 10 challenges per day
- **Storage optimization**: Old challenges are automatically cleaned up

## System Architecture

### Database Schema
```sql
-- Core challenge fields
id                 String    -- YouTube video ID
title              String    -- Video title
description        String    -- Video description
difficulty         String    -- beginner/intermediate/advanced
isAutoGenerated    Boolean   -- Auto vs user-created
dailyBatch         String    -- YYYY-MM-DD batch identifier
expiresAt          DateTime  -- Expiration date (30 days)
resources          JSON      -- Video URLs, thumbnails, etc.
```

### Key Functions

#### `fetchAllChallenges()`
- Checks database for today's challenges
- If < 10 auto-generated challenges exist, fetches new ones
- Combines auto-generated + user challenges
- Updates cache and database

#### `fetchCurrentChallenge()`
- Returns a single featured challenge for the user
- Cached per day to ensure consistency

#### `cleanupExpiredChallenges()`
- Removes auto-generated challenges older than 30 days
- Removes completed challenges older than 30 days

#### `cleanupOldDailyChallenges()`
- Keeps only latest 10 challenges per daily batch
- Prevents database bloat

## API Endpoints

### `/api/cron/refresh-challenges`
- **Purpose**: Daily refresh trigger for challenges
- **Method**: GET or POST
- **Auth**: Bearer token with CRON_SECRET
- **Actions**:
  1. Cleanup expired challenges
  2. Cleanup old daily challenges  
  3. Fetch new daily challenges
  4. Return status report

## Environment Variables
```env
CRON_SECRET=your_secure_random_string_for_cron_jobs
DATABASE_URL=your_database_url
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

## RLS Policies

### Service Role Permissions
```sql
-- Allow service role to create auto-generated challenges
CREATE POLICY "Service role can create auto-generated challenges"
ON challenges FOR INSERT
WITH CHECK (auth.role() = 'service_role' AND "isAutoGenerated" = true);

-- Allow service role to update auto-generated challenges  
CREATE POLICY "Service role can update auto-generated challenges"
ON challenges FOR UPDATE
WITH CHECK (auth.role() = 'service_role' AND "isAutoGenerated" = true);
```

## Frontend Implementation

### Challenge Page Structure
- **Daily Tab**: Shows today's 10 auto-generated challenges
- **Your Challenges Tab**: Shows user-created challenges
- **All Tab**: Combined view with search/filter
- **Difficulty Tabs**: Filter by skill level

### State Management
- `dailyChallenges`: Auto-generated challenges for today
- `userChallenges`: User-created challenges  
- `challenges`: Combined challenges array
- `filteredChallenges`: Filtered results based on active tab/search

## Testing

### Manual Test
```bash
npm run test:daily-challenges
```

### API Test
```bash
curl -X POST http://localhost:3000/api/cron/refresh-challenges \
  -H "Authorization: Bearer your_cron_secret"
```

## Deployment Considerations

### Cron Job Setup
Set up a daily cron job to hit the refresh endpoint:
```cron
0 6 * * * curl -X POST https://your-domain.com/api/cron/refresh-challenges -H "Authorization: Bearer your_cron_secret"
```

### Database Migration
Run the migration scripts:
1. `prisma/migrations/add_challenge_fields.sql`
2. `prisma/migrations/fix_service_role_policies.sql`

### Environment Setup
1. Copy `.env.example` to `.env.local`
2. Fill in all required environment variables
3. Generate a secure CRON_SECRET

## Troubleshooting

### Common Issues

**Challenges not refreshing**
- Check CRON_SECRET is set correctly
- Verify service role permissions in database
- Check API endpoint logs

**No videos fetching**
- YouTube scraping may be blocked
- Fallback videos should still work
- Check network connectivity

**Database errors**
- Verify RLS policies are applied
- Check service role key permissions
- Run migration scripts

### Debug Commands
```bash
# Test challenge system
npm run test:daily-challenges

# Check database connection
npm run test:db

# Manual refresh via API
curl -X POST localhost:3000/api/cron/refresh-challenges \
  -H "Authorization: Bearer $CRON_SECRET"
```

## Future Enhancements

1. **Admin Override**: Allow admins to manually select featured videos
2. **User Preferences**: Personalized challenge difficulty
3. **Progress Tracking**: Track user completion across challenges
4. **Analytics**: Monitor challenge engagement and completion rates
5. **Multiple Languages**: Support for other language learning
