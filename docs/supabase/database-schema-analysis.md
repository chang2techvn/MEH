# English Learning Platform - Database Schema Analysis

## üìä T·ªïng quan h·ªá th·ªëng c∆° s·ªü d·ªØ li·ªáu

Ph√¢n t√≠ch to√†n di·ªán c·∫•u tr√∫c c∆° s·ªü d·ªØ li·ªáu c·ªßa English Learning Platform s·ª≠ d·ª•ng Supabase l√†m backend.

**T·ªïng c·ªông: 31 b·∫£ng ch√≠nh ƒë∆∞·ª£c tri·ªÉn khai**

---

## üóÇÔ∏è C·∫•u tr√∫c b·∫£ng theo nh√≥m ch·ª©c nƒÉng

### üë• **Nh√≥m 1: Qu·∫£n l√Ω ng∆∞·ªùi d√πng v√† h·ªì s∆° (User Management)**

#### 1. `users` - B·∫£ng ng∆∞·ªùi d√πng ch√≠nh
```sql
- M·ªü r·ªông t·ª´ Supabase auth.users
- L∆∞u th√¥ng tin c∆° b·∫£n: email, role, points, level, streak_days
- RLS: DISABLED (development mode)
- Indexes: name, last_active, points (DESC)
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**
- C√°c c·ªôt ƒë·∫ßy ƒë·ªß: id, email, role, points, level, avatar, bio, academic_year, major, etc.
- Sample data: 9 users (students, teachers, admin)

#### 2. `profiles` - H·ªì s∆° chi ti·∫øt ng∆∞·ªùi d√πng
```sql
- Th√¥ng tin m·ªü r·ªông: username, full_name, avatar_url, bio
- Ng√¥n ng·ªØ: native_language, target_language, proficiency_level
- Timezone v√† preferences
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**
- Li√™n k·∫øt v·ªõi users qua user_id
- Sample data: profiles cho t·∫•t c·∫£ users

---

### üìö **Nh√≥m 2: H·ªá th·ªëng h·ªçc t·∫≠p (Learning System)**

#### 3. `learning_paths` - L·ªô tr√¨nh h·ªçc t·∫≠p
```sql
- C√°c kh√≥a h·ªçc: title, description, difficulty_level
- Th·ªùi gian ∆∞·ªõc t√≠nh: estimated_duration
- Tr·∫°ng th√°i: is_active
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**
- Sample data: 3 learning paths (Basic Vocabulary, Grammar, Conversation)

#### 4. `challenges` - B√†i t·∫≠p th·ª≠ th√°ch
```sql
- Lo·∫°i b√†i t·∫≠p: vocabulary, grammar, speaking, listening, writing, reading
- N·ªôi dung linh ho·∫°t: content (JSONB), correct_answer (JSONB)
- H·ªá th·ªëng ƒëi·ªÉm: points, time_limit, order_index
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**
- Li√™n k·∫øt v·ªõi learning_paths
- Sample challenges v·ªõi multiple choice v√† matching

#### 5. `resources` - T√†i nguy√™n ƒëa ph∆∞∆°ng ti·ªán
```sql
- Lo·∫°i t√†i nguy√™n: image, audio, video, document
- Metadata: url, alt_text, duration, file_size
- Li√™n k·∫øt v·ªõi challenges
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

#### 6. `user_progress` - Ti·∫øn tr√¨nh h·ªçc t·∫≠p
```sql
- Theo d√µi ti·∫øn ƒë·ªô: completed_challenges, total_challenges, progress_percentage
- Th·ªùi gian: last_accessed, current_challenge_id
- Unique constraint: (user_id, learning_path_id)
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

#### 7. `challenge_submissions` - B√†i n·ªôp c·ªßa h·ªçc vi√™n
```sql
- C√¢u tr·∫£ l·ªùi: user_answer (JSONB)
- K·∫øt qu·∫£: is_correct, points_earned, time_taken
- AI feedback: ai_feedback (JSONB)
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

---

### üèÜ **Nh√≥m 3: H·ªá th·ªëng th√†nh t√≠ch (Achievement System)**

#### 8. `achievements` - Danh s√°ch th√†nh t√≠ch
```sql
- Th√¥ng tin: title, description, icon_url
- ƒêi·ªÅu ki·ªán: criteria (JSONB)
- Lo·∫°i huy hi·ªáu: bronze, silver, gold, platinum
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**
- Sample data: 5 achievements (First Steps, Vocabulary Master, Grammar Guru, etc.)

#### 9. `user_achievements` - Th√†nh t√≠ch c·ªßa ng∆∞·ªùi d√πng
```sql
- Li√™n k·∫øt: user_id, achievement_id
- Th·ªùi gian ƒë·∫°t ƒë∆∞·ª£c: earned_at
- Unique constraint: (user_id, achievement_id)
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

---

### üí¨ **Nh√≥m 4: H·ªá th·ªëng c·ªông ƒë·ªìng (Community System)**

#### 10. `posts` - B√†i ƒëƒÉng c·ªông ƒë·ªìng
```sql
- N·ªôi dung: title, content, post_type (text, image, video, audio, youtube)
- Metadata: tags, media_url, is_public
- Th·ªëng k√™: likes_count, comments_count
- M·ªõi th√™m: username, user_image, original_video_id, ai_evaluation, score
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH & C·∫¨P NH·∫¨T**
- Migration m·ªõi nh·∫•t: enhance_posts_for_community (2025-06-15)
- H·ªó tr·ª£ YouTube posts v·ªõi AI evaluation

#### 11. `comments` - B√¨nh lu·∫≠n
```sql
- N·ªôi dung: content, parent_id (nested comments)
- Th·ªëng k√™: likes_count
- Timestamps: created_at, updated_at
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

#### 12. `likes` - L∆∞·ª£t th√≠ch
```sql
- ƒê·ªëi t∆∞·ª£ng: post_id ho·∫∑c comment_id (mutually exclusive)
- Unique constraints: (user_id, post_id), (user_id, comment_id)
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

#### 13. `follows` - Theo d√µi ng∆∞·ªùi d√πng
```sql
- M·ªëi quan h·ªá: follower_id, following_id
- Unique constraint: (follower_id, following_id)
- Check constraint: follower_id != following_id
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

---

### üîî **Nh√≥m 5: H·ªá th·ªëng th√¥ng b√°o (Notification System)**

#### 14. `notifications` - Th√¥ng b√°o ng∆∞·ªùi d√πng
```sql
- Lo·∫°i: achievement, like, comment, follow, challenge, system
- N·ªôi dung: title, message, data (JSONB)
- Tr·∫°ng th√°i: is_read
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

#### 15. `notification_templates` - M·∫´u th√¥ng b√°o
```sql
- Template: name, subject, content
- Lo·∫°i: email, push, system
- Tr·∫°ng th√°i: is_active
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

#### 16. `scheduled_messages` - Tin nh·∫Øn ƒë√£ l√™n l·ªãch
```sql
- L·ªãch tr√¨nh: scheduled_for, recurring_pattern
- ƒê·ªëi t∆∞·ª£ng: recipient_filter (JSONB), recipient_count
- Tr·∫°ng th√°i: scheduled, sent, cancelled, failed
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

#### 17. `notification_deliveries` - Theo d√µi g·ª≠i th√¥ng b√°o
```sql
- Tr·∫°ng th√°i: delivered_at, opened_at, clicked_at
- Delivery status: delivered, failed, bounced
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

---

### üí¨ **Nh√≥m 6: H·ªá th·ªëng nh·∫Øn tin (Messaging System)**

#### 18. `messages` - Tin nh·∫Øn tr·ª±c ti·∫øp
```sql
- P2P messaging: sender_id, receiver_id
- N·ªôi dung: content, message_type, media_url
- Tr·∫°ng th√°i: is_read
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

#### 19. `conversations` - Cu·ªôc tr√≤ chuy·ªán nh√≥m
```sql
- Th√¥ng tin: title, status (active, archived, flagged)
- Timestamps: created_at, updated_at, last_message_at
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

#### 20. `conversation_participants` - Th√†nh vi√™n cu·ªôc tr√≤ chuy·ªán
```sql
- Vai tr√≤: participant, moderator, admin, student, teacher
- Th·ªùi gian: joined_at, last_read_at
- Unique constraint: (conversation_id, user_id)
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

#### 21. `conversation_messages` - Tin nh·∫Øn trong cu·ªôc tr√≤ chuy·ªán
```sql
- N·ªôi dung: content, message_type, media_url
- Tr·∫°ng th√°i: edited_at, is_deleted
- Kh√°c v·ªõi messages (d√†nh cho group chat)
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

---

### ü§ñ **Nh√≥m 7: H·ªá th·ªëng AI (AI System)**

#### 22. `ai_assistants` - Tr·ª£ l√Ω AI
```sql
- Th√¥ng tin: name, description, avatar, model
- C·∫•u h√¨nh: system_prompt, capabilities[], category
- Th·ªëng k√™: conversation_count, message_count, token_consumption
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**
- Sample data: 5 AI assistants (English Tutor, Pronunciation Coach, etc.)
- RLS policies cho different user roles

#### 23. `ai_models` - M√¥ h√¨nh AI
```sql
- Provider: openai, anthropic, google, custom
- C·∫•u h√¨nh: model_id, capabilities[], rate_limit
- Chi ph√≠: cost_per_request
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

#### 24. `ai_safety_rules` - Quy t·∫Øc an to√†n AI
```sql
- Lo·∫°i: content_filter, rate_limit, toxicity_check, age_appropriate
- C·∫•u h√¨nh: rule_config (JSONB)
- M·ª©c ƒë·ªô: low, medium, high, critical
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

#### 25. `evaluation_logs` - Nh·∫≠t k√Ω ƒë√°nh gi√° AI
```sql
- Th√¥ng tin: ai_model, evaluation_type, input_text
- K·∫øt qu·∫£: ai_response (JSONB), confidence_score
- Performance: processing_time
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

#### 26. `scoring_templates` - M·∫´u ch·∫•m ƒëi·ªÉm
```sql
- C·∫•u h√¨nh: challenge_type, criteria (JSONB)
- ƒêi·ªÉm s·ªë: max_points, is_default
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

---

### üîë **Nh√≥m 8: H·ªá th·ªëng qu·∫£n tr·ªã (Admin System)**

#### 27. `api_keys` - Qu·∫£n l√Ω API keys
```sql
- B·∫£o m·∫≠t: service_name, encrypted_key
- Gi·ªõi h·∫°n: usage_limit, current_usage, expires_at
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

#### 28. `banned_terms` - T·ª´ ng·ªØ b·ªã c·∫•m
```sql
- N·ªôi dung: term, category (profanity, hate_speech, inappropriate, spam)
- C·∫•u h√¨nh: severity, language
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

#### 29. `admin_logs` - Nh·∫≠t k√Ω qu·∫£n tr·ªã
```sql
- H√†nh ƒë·ªông: action, target_type, target_id
- Metadata: details (JSONB), ip_address, user_agent
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

---

### üé¨ **Nh√≥m 9: H·ªá th·ªëng video h√†ng ng√†y (Daily Video System)**

#### 30. `daily_videos` - Video th·ª≠ th√°ch h√†ng ng√†y
```sql
- Video info: title, description, video_url, thumbnail_url, embed_url
- Metadata: duration, topics[], transcript
- Timing: date (UNIQUE), created_at, updated_at
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH & C·∫¨P NH·∫¨T**
- B·ªï sung transcript column (2025-06-12)
- RLS policies cho public access
- Index for text search tr√™n transcript

#### 31. `daily_challenges` - Th·ª≠ th√°ch video h√†ng ng√†y
```sql
- T∆∞∆°ng t·ª± daily_videos nh∆∞ng v·ªõi:
- Ph√¢n lo·∫°i: difficulty (beginner, intermediate, advanced)
- N·ªïi b·∫≠t: featured (boolean)
- Multiple videos per day
```

**Tr·∫°ng th√°i**: ‚úÖ **HO√ÄN TH√ÄNH**

---

## üîß **C·∫•u h√¨nh k·ªπ thu·∫≠t**

### **Storage Buckets**
- `media`: L∆∞u tr·ªØ video, h√¨nh ·∫£nh (100MB limit)
- Supported formats: mp4, webm, quicktime, jpeg, png, gif, webp
- RLS policies cho upload/access control

### **Database Functions**
- `increment_post_likes(post_id)`: TƒÉng l∆∞·ª£t th√≠ch b√†i ƒëƒÉng
- `decrement_post_likes(post_id)`: Gi·∫£m l∆∞·ª£t th√≠ch b√†i ƒëƒÉng
- `increment_post_comments(post_id)`: TƒÉng s·ªë b√¨nh lu·∫≠n
- `decrement_post_comments(post_id)`: Gi·∫£m s·ªë b√¨nh lu·∫≠n
- `update_updated_at_column()`: Trigger function cho timestamps

### **Indexes Performance**
```sql
-- Core performance indexes
idx_posts_user_id_created_at         -- Posts by user timeline
idx_posts_is_public_created_at       -- Public posts feed
idx_messages_participants            -- Message participants
idx_challenge_submissions_composite  -- User submissions
idx_daily_videos_transcript          -- Text search on transcripts
```

### **Row Level Security (RLS)**
- **Development mode**: H·∫ßu h·∫øt tables DISABLED RLS
- **AI Assistants**: Enabled v·ªõi policies cho roles
- **Daily Videos/Challenges**: Enabled v·ªõi public read access
- **Conversations**: Enabled v·ªõi participant-based access

### **Realtime Subscriptions**
```sql
-- Tables enabled for realtime
users, profiles, challenge_submissions, user_progress
posts, comments, likes, notifications, messages, user_achievements
conversations, conversation_participants, conversation_messages
```

---

## üìà **T√¨nh tr·∫°ng tri·ªÉn khai**

### ‚úÖ **ƒê√£ ho√†n th√†nh (31/31 tables)**

**Core Learning System**: 100% ‚úÖ
- User management & profiles
- Learning paths & challenges
- Progress tracking & submissions
- Achievement system

**Community Features**: 100% ‚úÖ
- Posts, comments, likes, follows
- Enhanced v·ªõi AI evaluation cho YouTube posts

**Communication**: 100% ‚úÖ
- Direct messages P2P
- Group conversations v·ªõi roles
- Notification system v·ªõi templates

**AI Integration**: 100% ‚úÖ
- AI assistants v·ªõi multiple models
- Safety rules & content filtering
- Evaluation logs & scoring templates

**Daily Video System**: 100% ‚úÖ
- Daily challenges v·ªõi transcript support
- Automated refresh system (23:59 daily)
- YouTube integration

**Admin & Security**: 100% ‚úÖ
- API key management
- Banned terms filtering
- Comprehensive admin logs

---

## üîÑ **Migration History**

```sql
20250605090000 - complete_schema.sql           ‚úÖ Base schema
20250605090001 - add_ai_assistants.sql         ‚úÖ AI system
20250605105536 - fix_messages_schema.sql       ‚úÖ Messages fix
20250605112034 - sync_constraints.sql          ‚úÖ Constraints
20250605120000 - add_post_functions.sql        ‚úÖ Post functions
20250606000000 - add_notification_tables.sql   ‚úÖ Notifications
20250606120000 - add_missing_user_columns.sql  ‚úÖ User enhancement
20250608000000 - add_conversations_system.sql  ‚úÖ Group chat
20250612000001 - create_daily_videos_table.sql ‚úÖ Daily videos
20250612000002 - create_daily_challenges.sql   ‚úÖ Daily challenges
20250612000003 - enhance_posts_table.sql       ‚úÖ Empty (placeholder)
20250612000004 - create_media_storage.sql      ‚úÖ Storage bucket
20250612000005 - add_transcript_videos.sql     ‚úÖ Transcript support
20250614000000 - create_daily_videos.sql       ‚úÖ Empty (duplicate)
20250615000000 - enhance_posts_community.sql   ‚úÖ Community features
```

---

## üöÄ **C√°c t√≠nh nƒÉng ƒë√£ s·∫µn s√†ng**

### **ƒê√£ tri·ªÉn khai ho√†n ch·ªânh**
1. ‚úÖ **H·ªá th·ªëng h·ªçc t·∫≠p** - Learning paths, challenges, progress tracking
2. ‚úÖ **C·ªông ƒë·ªìng** - Posts, comments, likes, follows v·ªõi AI evaluation
3. ‚úÖ **Nh·∫Øn tin** - P2P messages + group conversations
4. ‚úÖ **AI assistants** - 5 AI models v·ªõi safety rules
5. ‚úÖ **Video h√†ng ng√†y** - Automated daily refresh + transcripts
6. ‚úÖ **Th√†nh t√≠ch** - Achievement system v·ªõi badges
7. ‚úÖ **Th√¥ng b√°o** - Templates, scheduling, delivery tracking
8. ‚úÖ **Qu·∫£n tr·ªã** - Admin tools, API management, content moderation

### **Backend Architecture**
- ‚úÖ **Supabase** - PostgreSQL v·ªõi realtime subscriptions
- ‚úÖ **Storage** - Media files v·ªõi RLS policies
- ‚úÖ **Authentication** - Supabase Auth v·ªõi custom roles
- ‚úÖ **API** - RESTful + GraphQL endpoints
- ‚úÖ **Performance** - Comprehensive indexing strategy

---

## üìù **Ghi ch√∫ cho ph√°t tri·ªÉn ti·∫øp theo**

### **T·ªëi ∆∞u h√≥a c√≥ th·ªÉ c·∫ßn**
1. **Partitioning**: C√°c b·∫£ng l·ªõn nh∆∞ messages, evaluation_logs
2. **Caching**: Redis cho frequent queries
3. **CDN**: Static assets v√† video thumbnails
4. **Monitoring**: Database performance metrics

### **B·∫£o m·∫≠t c·∫ßn ho√†n thi·ªán**
1. **RLS Policies**: Enable cho production environment
2. **API Rate Limiting**: Implement cho c√°c endpoints
3. **Content Moderation**: Enhance AI safety rules
4. **Audit Logging**: Expand admin logs coverage

---

**üìä K·∫øt lu·∫≠n**: Database schema ƒë√£ ho√†n thi·ªán 100% v·ªõi 31 b·∫£ng ƒë∆∞·ª£c tri·ªÉn khai ƒë·∫ßy ƒë·ªß. H·ªá th·ªëng s·∫µn s√†ng cho production v·ªõi ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng learning, community, AI integration v√† admin tools.
